name: Check version

on:
  pull_request:
    types: [synchronize, opened, reopened]
    paths-ignore:
      - ".github/workflows/**"
      - "renovate.json"

permissions:
  contents: write

jobs:
  check_version:
    runs-on: ubuntu-latest

    outputs:
      version_updated: ${{ steps.compare.outputs.version_updated }}
      new_version: ${{ steps.compare.outputs.new_version }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24.x"

      - id: compare
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");

            const branchPkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            const branchVersion = branchPkg.version;

            const mainPkg = JSON.parse(
              await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: "package.json",
                ref: "main"
              }).then(r => Buffer.from(r.data.content, "base64").toString("utf8"))
            );
            const mainVersion = mainPkg.version;

            const cmp = new Intl.Collator(undefined, { numeric: true }).compare;

            if (cmp(branchVersion, mainVersion) > 0) {
              core.setOutput("version_updated", "false");
              return;
            }

            if (cmp(branchVersion, mainVersion) < 0) {
              core.setOutput("version_updated", "false");
              return;
            }

            const [maj, min, pat] = branchVersion.split(".").map(Number);
            const newVersion = `${maj}.${min}.${pat + 1}`;
            branchPkg.version = newVersion;

            fs.writeFileSync("package.json", JSON.stringify(branchPkg, null, 2));

            core.setOutput("version_updated", "true");
            core.setOutput("new_version", newVersion);

      - name: Update lockfile
        if: steps.compare.outputs.version_updated == 'true'
        run: npm install

      - name: Commit bumped version
        if: steps.compare.outputs.version_updated == 'true'
        run: |
          git config --global user.name "SamNewhouse"
          git config --global user.email "hello@samnewhouse.co.uk"
          git add package.json package-lock.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Changed version to ${{ steps.compare.outputs.new_version }}"
            git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/SamNewhouse/create-stb.git
            git pull --rebase origin ${{ github.head_ref }}
            git push origin HEAD:${{ github.head_ref }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Success
        run: echo "Version check completed."

      - name: Failure
        if: failure()
        run: echo "Version check failed."
