name: Test create-stb

on:
  pull_request_target:
    branches: [main]

permissions:
  contents: read

jobs:
  test-create-stb:
    name: Test create-stb CLI and Serverless Boilerplate (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ["20.x", "24.x"]
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}

      - run: npm ci

      - name: Run CLI Unit tests
        run: npm test

      - name: Build CLI
        run: npm run build

      - name: Verify dist files were created
        run: |
          test -f dist/create-stb.js || { echo "dist/create-stb.js missing"; exit 1; }
          test -f dist/create-stb.d.ts || { echo "dist/create-stb.d.ts missing"; exit 1; }

      - name: Link CLI globally
        run: npm link

      - name: Create and verify new-app
        run: |
          npx create-stb new-app || exit 1
          test -d new-app || { echo "new-app missing"; exit 1; }
          test -f new-app/package.json || { echo "package.json missing"; exit 1; }
          test -f new-app/serverless.yml || { echo "serverless.yml missing"; exit 1; }
          grep -q "service: new-app" new-app/serverless.yml || { echo "Service name not updated"; exit 1; }

      - name: Validate NPM scripts in new-app
        run: |
          for script in offline build deploy; do
            if ! grep -q "\"$script\"" "new-app/package.json"; then
              echo "NPM script '$script' missing in new-app"
              exit 1
            fi
          done

      - name: Verify package.json was updated correctly
        run: |
          cd new-app
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_DESC=$(node -p "require('./package.json').description")
          if [ "$PKG_NAME" != "new-app" ]; then
            echo "Package name not updated correctly: $PKG_NAME"
            exit 1
          fi
          if [ "$PKG_DESC" != "new-app app description" ]; then
            echo "Package description not updated correctly: $PKG_DESC"
            exit 1
          fi
          cd ..

      - name: Verify essential files exist
        run: |
          test -f new-app/.gitignore || { echo ".gitignore missing"; exit 1; }
          test -f new-app/tsconfig.json || { echo "tsconfig.json missing"; exit 1; }
          test -f new-app/docker-compose.yml || { echo "docker-compose.yml missing"; exit 1; }
          test -f new-app/.env.example || { echo ".env.example missing"; exit 1; }
          test -d new-app/src || { echo "src directory missing"; exit 1; }
          test -f new-app/README.md || { echo "README.md missing"; exit 1; }

      - name: Verify dotfiles were copied
        run: |
          test -f new-app/.prettierrc || { echo ".prettierrc missing"; exit 1; }
          test -f new-app/.prettierignore || { echo ".prettierignore missing"; exit 1; }

      - name: Verify src directory structure
        run: |
          test -d new-app/src/handlers || { echo "src/handlers missing"; exit 1; }
          test -d new-app/src/utils || { echo "src/utils missing"; exit 1; }

      - name: Install dependencies in new-app
        run: |
          cd new-app
          npm ci

      - name: Verify TypeScript compilation works
        run: |
          cd new-app
          npm run build || { echo "TypeScript build failed"; exit 1; }

      - name: Verify no node_modules in template
        run: |
          if [ -d new-app/node_modules/.cache ]; then
            echo "Warning: Cache directories found"
          fi

      - name: Test error handling - existing non-empty directory
        run: |
          mkdir -p existing-dir
          echo "test" > existing-dir/file.txt
          if npx create-stb existing-dir 2>&1 | grep -q "not empty"; then
            echo "Error handling works correctly"
          else
            echo "Should have failed for non-empty directory"
            exit 1
          fi
          rm -rf existing-dir

      - name: Test error handling - no project name
        run: |
          if npx create-stb 2>&1 | grep -q "provide a project name"; then
            echo "Error handling works correctly"
          else
            echo "Should have failed without project name"
            exit 1
          fi

      - name: Test with different project name format
        run: |
          npx create-stb my-cool-app
          grep -q "service: my-cool-app" my-cool-app/serverless.yml || { echo "Service name not updated for hyphenated name"; exit 1; }
          rm -rf my-cool-app

      - name: Verify package size
        run: |
          npm pack
          SIZE=$(stat -f%z create-stb-*.tgz 2>/dev/null || stat -c%s create-stb-*.tgz)
          echo "Package size: $SIZE bytes ($((SIZE / 1024)) KB)"
          if [ $SIZE -gt 102400 ]; then
            echo "Warning: Package size is larger than expected (>100KB)"
          fi

      - name: Verify package contents
        run: |
          tar -tzf create-stb-*.tgz > package-contents.txt
          echo "Package contents:"
          cat package-contents.txt
          # Ensure serverless folder is NOT in the package
          if grep -q "serverless/" package-contents.txt; then
            echo "Error: serverless folder should not be in the package"
            exit 1
          fi

      - name: Check code formatting
        run: npm run format -- --check

      - name: Cleanup
        run: |
          rm -rf new-app
          rm -f create-stb-*.tgz package-contents.txt

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: "24.x"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Check for known vulnerabilities in production
        run: npm audit --production --audit-level=high

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: "24.x"

      - run: npm ci

      - name: Check code formatting
        run: npm run format -- --check

      - name: Run TypeScript compiler check
        run: npx tsc --noEmit
